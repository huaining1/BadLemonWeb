---
title: "ESP32-S3 çš„ IÂ²Cï¼šä»â€œèƒ½è¿è®¾å¤‡â€åˆ°â€œå·¥ç¨‹ä¸Šç”¨å¾—é¡ºâ€"
category: "ESP32"
tags: [ESP32, é€šä¿¡åè®®,ESP-IDF]
featured: false
---
# ESP32-S3 çš„ IÂ²Cï¼šä»â€œèƒ½è¿è®¾å¤‡â€åˆ°â€œå·¥ç¨‹ä¸Šç”¨å¾—é¡ºâ€

åœ¨åˆšå¼€å§‹æ¥è§¦ ESP32-S3 çš„æ—¶å€™ï¼Œæˆ‘å¯¹ IÂ²C çš„ç†è§£å…¶å®éå¸¸ç®€å•ï¼š

> ä¸¤æ ¹çº¿ï¼Œèƒ½è¿ä¼ æ„Ÿå™¨ï¼Œèƒ½ç‚¹äº® OLEDã€‚

ä½†çœŸæ­£å¼€å§‹åšå¤šå¤–è®¾ã€å¤šä»»åŠ¡çš„é¡¹ç›®åï¼Œæˆ‘æ‰æ„è¯†åˆ°ï¼š
**IÂ²C å¹¶ä¸æ˜¯ä¸€ä¸ªâ€œæ¥å£â€ï¼Œè€Œæ˜¯ä¸€æ¡â€œå…±äº«æ€»çº¿èµ„æºâ€ã€‚**

å¦‚æœä½ åªæ˜¯â€œä¼šç”¨â€ï¼Œé—®é¢˜ä¸å¤§ï¼›
ä½†å¦‚æœä½ æƒ³**æŠŠç³»ç»Ÿè·‘ç¨³**ï¼ŒIÂ²C çš„è®¾è®¡é€»è¾‘ä¸€å®šè¦æƒ³æ¸…æ¥šã€‚

---

## ä¸€ã€å…ˆä» ESP32-S3 çš„è§†è§’è®¤è¯† IÂ²C

IÂ²Cï¼ˆInter-Integrated Circuitï¼‰æ˜¯ä¸€ç§ï¼š
* ä¸²è¡Œ
* åŒæ­¥
* åŠåŒå·¥
* æ”¯æŒå¤šè®¾å¤‡æŒ‚è½½

çš„é€šä¿¡åè®®ã€‚

åœ¨ ESP32-S3 ä¸Šï¼Œæœ‰ **2 ä¸ª IÂ²C æ§åˆ¶å™¨ï¼ˆPortï¼‰**ï¼Œæ¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼š
* æ—¢å¯ä»¥ä½œä¸º **ä¸»æœº**
* ä¹Ÿå¯ä»¥ä½œä¸º **ä»æœº**

ä½†åœ¨ç»å¤§å¤šæ•°å®é™…é¡¹ç›®ä¸­ï¼š

> **ESP32-S3 å‡ ä¹æ°¸è¿œæ˜¯ IÂ²C ä¸»æœº**

å› ä¸ºï¼š
* ä¼ æ„Ÿå™¨æ˜¯ä»æœº
* OLED æ˜¯ä»æœº
* EEPROM ä¹Ÿæ˜¯ä»æœº

---

## äºŒã€IÂ²C çš„ä¸»ä»æ¨¡å‹ï¼Œåœ¨å·¥ç¨‹é‡Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

### ä¸»è®¾å¤‡ï¼ˆMasterï¼‰
* äº§ç”Ÿ SCL æ—¶é’Ÿ
* å‘èµ·é€šä¿¡
* æŒ‡å®šç›®æ ‡è®¾å¤‡åœ°å€
* å†³å®šâ€œä»€ä¹ˆæ—¶å€™è¯» / ä»€ä¹ˆæ—¶å€™å†™â€

### ä»è®¾å¤‡ï¼ˆSlaveï¼‰
* è¢«åŠ¨å“åº”
* æ ¹æ®åœ°å€åº”ç­”
* æŒ‰åè®®è¿”å›æ•°æ®

è¿™æ„å‘³ç€ä¸€ä»¶å¾ˆå…³é”®çš„äº‹æƒ…ï¼š
> **IÂ²C æ€»çº¿çš„èŠ‚å¥ï¼Œæ°¸è¿œç”±ä¸»æœºæŒæ§**

ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼ŒESP32-S3 çš„ IÂ²C é©±åŠ¨è®¾è®¡ï¼Œæœ¬è´¨ä¸Šæ˜¯**å›´ç»•â€œä¸»æœºâ€å±•å¼€çš„**ã€‚

---

## ä¸‰ã€ESP-IDF ä¸­çš„ IÂ²Cï¼šä¸æ˜¯â€œæ¥å£â€ï¼Œè€Œæ˜¯â€œæ€»çº¿ + è®¾å¤‡â€

ESP-IDF å¹¶æ²¡æœ‰æŠŠ IÂ²C è®¾è®¡æˆâ€œåˆå§‹åŒ–ä¸€æ¬¡å°±å®Œäº‹â€çš„æ¥å£ï¼Œè€Œæ˜¯æ˜ç¡®æ‹†æˆäº†ä¸¤å±‚ï¼š
* **IÂ²C Busï¼ˆæ€»çº¿ï¼‰**
* **IÂ²C Deviceï¼ˆè®¾å¤‡ï¼‰**

è¿™ç‚¹éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒç›´æ¥å½±å“ä½ åé¢çš„ç³»ç»Ÿç»“æ„ã€‚

### åœ¨ ESP-IDF ä¸­ï¼ŒIÂ²C ä¸»æœºçš„ä½¿ç”¨æµç¨‹åªæœ‰ä¸‰æ­¥ï¼š

1. åˆå§‹åŒ– IÂ²C æ€»çº¿
2. æŠŠè®¾å¤‡æŒ‚åˆ°æ€»çº¿ä¸Š
3. é€šè¿‡è®¾å¤‡å¥æŸ„è¿›è¡Œè¯»å†™

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3c959419350c45228a74217cef396132.png)

---

## å››ã€åˆå§‹åŒ– IÂ²C æ€»çº¿ï¼šä½ æ˜¯åœ¨â€œåˆ›å»ºä¸€æ¡å…¬å…±èµ„æºâ€

ä½¿ç”¨ `i2c_new_master_bus()` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨åšä¸€ä»¶äº‹ï¼š

> **åˆ›å»ºä¸€æ¡å¯è¢«å¤šä¸ªè®¾å¤‡å…±äº«çš„é€šä¿¡æ€»çº¿**

```c
i2c_master_bus_config_t i2c_bus_config = {
    .clk_source = I2C_CLK_SRC_DEFAULT,
    .i2c_port = -1,
    .scl_io_num = SCL_IO_PIN,
    .sda_io_num = SDA_IO_PIN,
    .glitch_ignore_cnt = 7,
    .flags.enable_internal_pullup = true,
};

i2c_master_bus_handle_t bus_handle;
ESP_ERROR_CHECK(i2c_new_master_bus(&i2c_bus_config, &bus_handle));
```
**i2c_new_master_bus**
```c
esp_err_t i2c_new_master_bus(const i2c_master_bus_config_t *config, i2c_master_bus_handle_t *bus_handle);

å‚æ•°è¯´æ˜
config :æŒ‡å‘ i2c_master_bus_config_t ç»“æ„ä½“çš„æŒ‡é’ˆï¼ŒåŒ…å« I2C æ€»çº¿çš„é…ç½®å‚æ•°ã€‚
bus_handle:ç”¨äºå­˜å‚¨æ–°åˆ›å»ºçš„ I2C æ€»çº¿å¥æŸ„çš„æŒ‡é’ˆã€‚æˆåŠŸè°ƒç”¨åï¼Œè¯¥å¥æŸ„å¯ç”¨äºåç»­çš„ I2C æ“ä½œã€‚

è¿”å›å€¼
ESP_OK: æˆåŠŸåˆ›å»ºå¹¶åˆå§‹åŒ– I2C æ€»çº¿ã€‚
```

è¿™é‡Œæœ‰ä¸¤ä¸ª**éå¸¸å®¹æ˜“è¢«å¿½ç•¥çš„ç‚¹**ï¼š

* **SCL / SDA æ˜¯æ•´æ¡æ€»çº¿çš„èµ„æº**
* ä¸Šæ‹‰ç”µé˜»æ˜¯å¦å­˜åœ¨ï¼Œç›´æ¥å†³å®šæ€»çº¿æ˜¯å¦ç¨³å®š

---

## äº”ã€æ·»åŠ  IÂ²C è®¾å¤‡ï¼šè®¾å¤‡ä¸æ˜¯â€œåˆå§‹åŒ–â€ï¼Œè€Œæ˜¯â€œæ³¨å†Œâ€

å½“ä½ è°ƒç”¨ `i2c_master_bus_add_device()` æ—¶ï¼š
* å¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•é€šä¿¡
* åªæ˜¯å‘Šè¯‰é©±åŠ¨ï¼š

  > è¿™æ¡æ€»çº¿ä¸Šï¼Œæœ‰ä¸€ä¸ªåœ°å€ä¸º XX çš„è®¾å¤‡

```c
i2c_device_config_t dev_cfg = {
    .dev_addr_length = I2C_ADDR_BIT_LEN_7,
    .device_address = DEVICE_ADDR,
    .scl_speed_hz = 400000,
};

i2c_master_dev_handle_t dev_handle;
ESP_ERROR_CHECK(i2c_master_bus_add_device(bus_handle, &dev_cfg, &dev_handle));
```
**i2c_master_bus_add_device**
```c
esp_err_t i2c_master_bus_add_device(i2c_master_bus_handle_t bus_handle, const i2c_device_config_t *dev_cfg, i2c_master_dev_handle_t *dev_handle);

å‚æ•°è¯´æ˜
bus_handle:å·²åˆ›å»ºçš„ I2C æ€»çº¿å¥æŸ„ï¼Œç”± i2c_new_master_bus åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚
dev_cfg:æŒ‡å‘ i2c_device_config_t ç»“æ„ä½“çš„æŒ‡é’ˆï¼ŒåŒ…å«è¦æ·»åŠ çš„ I2C è®¾å¤‡çš„é…ç½®å‚æ•°ã€‚
dev_handle:ç”¨äºå­˜å‚¨æ–°åˆ›å»ºçš„ I2C è®¾å¤‡å¥æŸ„çš„æŒ‡é’ˆã€‚æˆåŠŸè°ƒç”¨åï¼Œè¯¥å¥æŸ„å¯ç”¨äºåç»­ä¸è¯¥è®¾å¤‡çš„é€šä¿¡æ“ä½œã€‚

è¿”å›å€¼
ESP_OK: æˆåŠŸæ·»åŠ  I2C è®¾å¤‡ã€‚
```

è¿™ä¸€å±‚è®¾è®¡ï¼Œç›´æ¥å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼š

> **ä¸€ä¸ªæ€»çº¿ï¼Œå¯ä»¥éå¸¸å¹²å‡€åœ°ç®¡ç†å¤šä¸ª IÂ²C å¤–è®¾**

---

## å…­ã€IÂ²C çš„ä¸‰ç§â€œæ ‡å‡†äº‹åŠ¡â€ï¼Œä½ ä¸€å®šä¼šå…¨éƒ¨ç”¨åˆ°

### 1ï¸âƒ£ ä¸»æœºå†™ï¼ˆTransmitï¼‰

æœ€å…¸å‹çš„åœºæ™¯ï¼š

* OLED å†™å‘½ä»¤
* ä¼ æ„Ÿå™¨ä¸‹å‘æµ‹é‡æŒ‡ä»¤

æˆåŠŸå®‰è£… I2C ä¸»æœºæ€»çº¿ä¹‹åï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨i2c_master_transmitæ¥å‘ä»æœºè®¾å¤‡å†™å…¥æ•°æ®ã€‚
```c
// è¦å‘é€çš„æ•°æ®
uint8_t data_to_send[] = {0x01, 0x02, 0x03, 0x04};

// å‘é€æ•°æ®
esp_err_t ret = i2c_master_transmit(dev_handle, data_to_send, sizeof(data_to_send), pdMS_TO_TICKS(1000));
if (ret == ESP_OK) {
    ESP_LOGI(TAG, "Data transmitted successfully");
} else {
    ESP_LOGE(TAG, "Failed to transmit data: %d", ret);
}
```
**i2c_master_transmit**
```c
esp_err_t i2c_master_transmit(i2c_master_dev_handle_t dev_handle, const uint8_t *data, size_t length, TickType_t ticks_to_wait);

å‚æ•°è¯´æ˜
dev_handle (i2c_master_dev_handle_t):I2C è®¾å¤‡å¥æŸ„ï¼Œè¯¥å¥æŸ„æ˜¯é€šè¿‡ i2c_master_bus_add_device å‡½æ•°åˆ›å»ºçš„ã€‚
data (const uint8_t *):æŒ‡å‘è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚è¯¥ç¼“å†²åŒºåŒ…å«è¦é€šè¿‡ I2C æ€»çº¿å‘é€çš„æ•°æ®å­—èŠ‚ã€‚
length (size_t):è¦å‘é€çš„æ•°æ®é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚æŒ‡å®šå‘é€å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚
ticks_to_wait (TickType_t):ç­‰å¾…é˜Ÿåˆ—å¯ç”¨çš„æ—¶é—´ï¼Œå•ä½ä¸º FreeRTOS çš„æ»´ç­”æ•°ã€‚å¦‚æœè®¾ç½®ä¸º portMAX_DELAYï¼Œåˆ™ä»»åŠ¡å°†æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°æœ‰èµ„æºå¯ç”¨ï¼›å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸ä¼šç­‰å¾…ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚

è¿”å›å€¼
ESP_OK: æˆåŠŸå‘é€æ•°æ®ã€‚
ESP_ERR_TIMEOUT: åœ¨æŒ‡å®šæ—¶é—´å†…æ— æ³•è·å– I2C æ€»çº¿è®¿é—®æƒé™æˆ–é˜Ÿåˆ—æ»¡ã€‚
```


![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7bd875ea9f4b479f9e70a51044a29064.png)

---

### 2ï¸âƒ£ ä¸»æœºè¯»ï¼ˆReceiveï¼‰

å…¸å‹åœºæ™¯ï¼š

* è¯»å–ä¼ æ„Ÿå™¨æµ‹é‡å€¼

```c
    // å‡†å¤‡æ¥æ”¶ç¼“å†²åŒº
    uint8_t data_received[10] = {0};  // å‡è®¾æœ€å¤šæ¥æ”¶ 10 å­—èŠ‚æ•°æ®

    // æ¥æ”¶æ•°æ®
    esp_err_t ret = i2c_master_receive(dev_handle, data_received, sizeof(data_received), pdMS_TO_TICKS(1000));
    if (ret == ESP_OK) {
        ESP_LOGI(TAG, "Data received successfully: ");
        for (int i = 0; i < sizeof(data_received); i++) {
            printf("0x%02X ", data_received[i]);
        }
        printf("\n");
    } else {
        ESP_LOGE(TAG, "Failed to receive data: %d", ret);
    }
```

**i2c_master_receive**
```c
esp_err_t i2c_master_receive(i2c_master_dev_handle_t dev_handle, uint8_t *data, size_t length, TickType_t ticks_to_wait);
å‚æ•°è¯´æ˜
dev_handle (i2c_master_dev_handle_t):I2C è®¾å¤‡å¥æŸ„ï¼Œè¡¨ç¤ºè¦é€šä¿¡çš„å…·ä½“ I2C ä»è®¾å¤‡ã€‚
data (uint8_t *):æŒ‡å‘æ¥æ”¶ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚è¯¥ç¼“å†²åŒºç”¨äºå­˜å‚¨ä» I2C ä»è®¾å¤‡æ¥æ”¶åˆ°çš„æ•°æ®å­—èŠ‚ã€‚
length (size_t):è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚æŒ‡å®šæ¥æ”¶å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚
ticks_to_wait (TickType_t):ç­‰å¾…é˜Ÿåˆ—å¯ç”¨çš„æ—¶é—´ï¼Œå•ä½ä¸º FreeRTOS çš„æ»´ç­”æ•°ã€‚å¦‚æœè®¾ç½®ä¸º portMAX_DELAYï¼Œåˆ™ä»»åŠ¡å°†æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°æœ‰èµ„æºå¯ç”¨ï¼›å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸ä¼šç­‰å¾…ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚
è¿”å›å€¼
ESP_OK: æˆåŠŸæ¥æ”¶æ•°æ®ã€‚
ESP_ERR_TIMEOUT: åœ¨æŒ‡å®šæ—¶é—´å†…æ— æ³•è·å– I2C æ€»çº¿è®¿é—®æƒé™æˆ–é˜Ÿåˆ—æ»¡ã€‚
```

![ğŸ“Œ **ã€æ­¤å¤„é¢„ç•™ï¼šIÂ²C è¯»æ—¶åºå›¾ã€‘**](https://i-blog.csdnimg.cn/direct/c8fc03317b044421b2054aea29b7e99e.png)


---

### 3ï¸âƒ£ å†™åè¯»ï¼ˆTransmit + Receiveï¼‰

è¿™æ˜¯ IÂ²C é‡Œ**æœ€å®¹æ˜“è¢«å¿½ç•¥ã€ä½†æœ€å¸¸ç”¨**çš„ä¸€ç§äº‹åŠ¡ã€‚

å…¸å‹åœºæ™¯ï¼š

* EEPROM è¯»å¯„å­˜å™¨
* ä¼ æ„Ÿå™¨è¯»å¯„å­˜å™¨

ä»ä¸€äº› I2C è®¾å¤‡ä¸­è¯»å–æ•°æ®ä¹‹å‰éœ€è¦è¿›è¡Œå†™å…¥é…ç½®ï¼Œå¯é€šè¿‡ i2c_master_transmit_receiveæ¥å£è¿›è¡Œé…ç½®ã€‚
```c
    // è¿™é‡Œå¯ä»¥ç»§ç»­æ·»åŠ ä¸ I2C è®¾å¤‡é€šä¿¡çš„ä»£ç 
    // è¦å‘é€çš„æ•°æ®ï¼ˆä¾‹å¦‚å‘½ä»¤æˆ–å¯„å­˜å™¨åœ°å€ï¼‰
    uint8_t command[] = {0x01};  // å‡è®¾æˆ‘ä»¬è¦è¯»å–å¯„å­˜å™¨ 0x01 çš„å†…å®¹

    // å‡†å¤‡æ¥æ”¶ç¼“å†²åŒº
    uint8_t data_received[10] = {0};  // å‡è®¾æœ€å¤šæ¥æ”¶ 10 å­—èŠ‚æ•°æ®

    // å‘é€å‘½ä»¤å¹¶æ¥æ”¶æ•°æ®
    esp_err_t ret = i2c_master_transmit_receive(dev_handle, command, sizeof(command), data_received, sizeof(data_received), pdMS_TO_TICKS(1000));
    if (ret == ESP_OK) {
        ESP_LOGI(TAG, "Data received successfully: ");
        for (int i = 0; i < sizeof(data_received); i++) {
            printf("0x%02X ", data_received[i]);
        }
        printf("\n");
    } else {
        ESP_LOGE(TAG, "Failed to transmit and receive data: %d", ret);
    }
```
**i2c_master_transmit_receive**
```c
esp_err_t i2c_master_transmit_receive(i2c_master_dev_handle_t dev_handle, const uint8_t *tx_data, size_t tx_length, uint8_t *rx_data, size_t rx_length, TickType_t ticks_to_wait);
å‚æ•°è¯´æ˜
dev_handle (i2c_master_dev_handle_t):
I2C è®¾å¤‡å¥æŸ„ï¼Œè¡¨ç¤ºè¦é€šä¿¡çš„å…·ä½“ I2C ä»è®¾å¤‡ã€‚è¯¥å¥æŸ„æ˜¯é€šè¿‡ i2c_master_bus_add_device å‡½æ•°åˆ›å»ºçš„ã€‚
tx_data (const uint8_t *):
æŒ‡å‘è¦å‘é€çš„æ•°æ®ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚è¯¥ç¼“å†²åŒºåŒ…å«è¦é€šè¿‡ I2C æ€»çº¿å‘é€çš„æ•°æ®å­—èŠ‚ã€‚
tx_length (size_t):
è¦å‘é€çš„æ•°æ®é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚æŒ‡å®šå‘é€å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚
rx_data (uint8_t *):
æŒ‡å‘æ¥æ”¶ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚è¯¥ç¼“å†²åŒºç”¨äºå­˜å‚¨ä» I2C ä»è®¾å¤‡æ¥æ”¶åˆ°çš„æ•°æ®å­—èŠ‚ã€‚
rx_length (size_t):
è¦æ¥æ”¶çš„æ•°æ®é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚æŒ‡å®šæ¥æ”¶å¤šå°‘ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚
ticks_to_wait (TickType_t):
ç­‰å¾…é˜Ÿåˆ—å¯ç”¨çš„æ—¶é—´ï¼Œå•ä½ä¸º FreeRTOS çš„æ»´ç­”æ•°ã€‚å¦‚æœè®¾ç½®ä¸º portMAX_DELAYï¼Œåˆ™ä»»åŠ¡å°†æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°æœ‰èµ„æºå¯ç”¨ï¼›å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™ä¸ä¼šç­‰å¾…ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚
è¿”å›å€¼
ESP_OK: æˆåŠŸå‘é€å’Œæ¥æ”¶æ•°æ®ã€‚
```

> ä¸­é—´æ²¡æœ‰ STOPï¼Œè¿™ä¸€ç‚¹å¯¹å¾ˆå¤šå™¨ä»¶éå¸¸å…³é”®ã€‚

![ğŸ“Œ **ã€æ­¤å¤„é¢„ç•™ï¼šRepeated START æ—¶åºå›¾ã€‘**](https://i-blog.csdnimg.cn/direct/5a7440a936514917a8c6b56cf3c28105.png)


---

## ä¸ƒã€IÂ²C æ¢æµ‹ï¼šé¡¹ç›®æ—©æœŸéå¸¸æœ‰ç”¨çš„å·¥å…·

åœ¨è°ƒè¯•é˜¶æ®µï¼Œæˆ‘å‡ ä¹ä¸€å®šä¼šå…ˆåšä¸€ä»¶äº‹ï¼š

> **æ‰«æ€»çº¿ï¼Œçœ‹è®¾å¤‡åœ¨ä¸åœ¨**

```c
    // æ¢æµ‹è®¾å¤‡
    esp_err_t ret = i2c_master_probe(bus_handle, DEVICE_ADDR, 1000);
    if (ret == ESP_OK) {
        ESP_LOGI(TAG, "Device at address 0x%02X found and responsive", DEVICE_ADDR);
    } else if (ret == ESP_ERR_NOT_FOUND) {
        ESP_LOGE(TAG, "Failed to find device at address 0x%02X", DEVICE_ADDR);
    } else if (ret == ESP_ERR_TIMEOUT) {
        ESP_LOGE(TAG, "Timeout while probing device at address 0x%02X", DEVICE_ADDR);
    } else {
        ESP_LOGE(TAG, "Failed to probe device at address 0x%02X: %d", DEVICE_ADDR, ret);
    }
```
**i2c_master_probe**
```c
è¯¥å‡½æ•°ç”¨äºæ¢æµ‹æŒ‡å®šåœ°å€çš„ I2C è®¾å¤‡æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœåœ°å€æ­£ç¡®å¹¶ä¸”æ¥æ”¶åˆ° ACKï¼ˆåº”ç­”ï¼‰
esp_err_t i2c_master_probe(i2c_master_bus_handle_t bus_handle, uint16_t address, int xfer_timeout_ms)
å‚æ•°
bus_handle (i2c_master_bus_handle_t):I2C ä¸»è®¾å¤‡æ€»çº¿å¥æŸ„ï¼Œç”± i2c_new_master_bus åˆ›å»ºã€‚
address (uint16_t):è¦æ¢æµ‹çš„ I2C è®¾å¤‡åœ°å€ï¼ˆ7 ä½æˆ– 10 ä½åœ°å€ï¼‰ã€‚
xfer_timeout_ms (int):ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚æ³¨æ„ï¼š-1 è¡¨ç¤ºæ— é™æœŸç­‰å¾…ï¼ˆä¸æ¨èåœ¨æ­¤å‡½æ•°ä¸­ä½¿ç”¨ï¼‰ã€‚
è¿”å›å€¼
ESP_OK: I2C è®¾å¤‡æ¢æµ‹æˆåŠŸã€‚
ESP_ERR_NOT_FOUND: I2C æ¢æµ‹å¤±è´¥ï¼Œæœªæ‰¾åˆ°æŒ‡å®šåœ°å€çš„è®¾å¤‡ã€‚
```

å¦‚æœ probe éƒ½ä¸é€šè¿‡ï¼š
* æ¥çº¿
* ä¸Šæ‹‰
* åœ°å€

ä¸€å®šæœ‰é—®é¢˜ã€‚

![ğŸ“Œ **ã€æ­¤å¤„é¢„ç•™ï¼šIÂ²C æ¢æµ‹æµç¨‹å›¾ã€‘**](https://i-blog.csdnimg.cn/direct/fb03f087e8fe439283200e1bace49a34.png)


---

## å…«ã€ä¸ºä»€ä¹ˆ IÂ²C ç‰¹åˆ«é€‚åˆ OLEDï¼Ÿ

ä»¥å¸¸è§çš„ SSD1306 OLED ä¸ºä¾‹ï¼š
* æ•°æ®é‡ä¸å¤§
* åˆ·æ–°é¢‘ç‡ä¸é«˜
* åˆå§‹åŒ–å‘½ä»¤å¤š

è¿™æ­£å¥½å‘½ä¸­ IÂ²C çš„ä¼˜åŠ¿åŒºé—´ï¼š
* çœ GPIO
* åè®®ç®€å•
* å¤šè®¾å¤‡å…¼å®¹

OLED åªå ç”¨ ä¸¤æ ¹çº¿ï¼š

OLED|	ESP32-S3|
---|---
SDA	|GPIO 21
SCL	|GPIO 20
VCC|	3.3V
GND|	GND

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/d68741f16ab84cb2b983c7f35e6c10c7.png)


---

## ä¹ã€OLED ç‚¹äº®å®ä¾‹ï¼ˆå·¥ç¨‹çº§æ€è·¯ï¼‰

åœ¨å·¥ç¨‹é‡Œï¼Œæˆ‘é€šå¸¸ä¼šè¿™æ ·æ‹†ï¼š

1. **IÂ²C æ€»çº¿åˆå§‹åŒ–**
2. **OLED è®¾å¤‡æ³¨å†Œ**
3. **OLED é©±åŠ¨å†…éƒ¨å°è£… IÂ²C å†™æ“ä½œ**
4. **ä¸Šå±‚åªå…³å¿ƒâ€œæ˜¾ç¤ºä»€ä¹ˆâ€**


oledé©±åŠ¨ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

```c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "oled.h"
#include "driver/i2c_master.h"
#include "esp_err.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

// OLED é…ç½®å‚æ•°
#define OLED_I2C_ADDRESS 0x3C        // SSD1306 çš„ 7 ä½ I2C åœ°å€ï¼ˆ0x78 æ˜¯ 8 ä½å†™åœ°å€ï¼Œ7 ä½åœ°å€æ˜¯ 0x3Cï¼‰
#define OLED_I2C_SDA_PIN 21          // SDA å¼•è„š
#define OLED_I2C_SCL_PIN 20          // SCL å¼•è„š
#define OLED_I2C_FREQ 100000         // I2C é¢‘ç‡ 100kHzï¼ˆé™ä½é¢‘ç‡ä»¥æé«˜å…¼å®¹æ€§ï¼‰
#define OLED_WIDTH 128               // OLED å®½åº¦ï¼ˆåƒç´ ï¼‰
#define OLED_HEIGHT 64               // OLED é«˜åº¦ï¼ˆåƒç´ ï¼‰
#define OLED_PAGES (OLED_HEIGHT / 8) // OLED é¡µæ•°ï¼ˆæ¯é¡µ 8 è¡Œï¼‰

// SSD1306 å‘½ä»¤å®šä¹‰
#define SSD1306_SETCONTRAST 0x81
#define SSD1306_DISPLAYALLON_RESUME 0xA4
#define SSD1306_DISPLAYALLON 0xA5
#define SSD1306_NORMALDISPLAY 0xA6
#define SSD1306_INVERTDISPLAY 0xA7
#define SSD1306_DISPLAYOFF 0xAE
#define SSD1306_DISPLAYON 0xAF
#define SSD1306_SETDISPLAYOFFSET 0xD3
#define SSD1306_SETCOMPINS 0xDA
#define SSD1306_SETVCOMDETECT 0xDB
#define SSD1306_SETDISPLAYCLOCKDIV 0xD5
#define SSD1306_SETPRECHARGE 0xD9
#define SSD1306_SETMULTIPLEX 0xA8
#define SSD1306_SETLOWCOLUMN 0x00
#define SSD1306_SETHIGHCOLUMN 0x10
#define SSD1306_SETSTARTLINE 0x40
#define SSD1306_MEMORYMODE 0x20
#define SSD1306_COLUMNADDR 0x21
#define SSD1306_PAGEADDR 0x22
#define SSD1306_COMSCANINC 0xC0
#define SSD1306_COMSCANDEC 0xC8
#define SSD1306_SEGREMAP 0xA0
#define SSD1306_CHARGEPUMP 0x8D
#define SSD1306_EXTERNALVCC 0x1
#define SSD1306_SWITCHCAPVCC 0x2

// I2C æ§åˆ¶å­—èŠ‚
#define OLED_CONTROL_BYTE_CMD_SINGLE 0x80  // å•å­—èŠ‚å‘½ä»¤
#define OLED_CONTROL_BYTE_CMD_STREAM 0x00 // å‘½ä»¤æµ
#define OLED_CONTROL_BYTE_DATA_STREAM 0x40 // æ•°æ®æµ

// I2C å¥æŸ„
static i2c_master_bus_handle_t bus_handle = NULL;
static i2c_master_dev_handle_t dev_handle = NULL;

// æ˜¾ç¤ºç¼“å†²åŒºï¼ˆ128x64 = 1024 å­—èŠ‚ï¼‰
static uint8_t oled_buffer[OLED_WIDTH * OLED_PAGES];

// 8x8 å­—ä½“ï¼ˆASCII 32-127ï¼‰
static const uint8_t font_8x8[][8] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ç©ºæ ¼
    {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // !
    {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00}, // #
    {0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00}, // $
    {0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00}, // %
    {0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00}, // &
    {0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    {0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00}, // (
    {0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00}, // )
    {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}, // *
    {0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00}, // +
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x06, 0x00}, // ,
    {0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00}, // -
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // .
    {0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00}, // /
    {0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x63, 0x3E}, // 0
    {0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F}, // 1
    {0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x33, 0x3F}, // 2
    {0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x33, 0x1E}, // 3
    {0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x30, 0x78}, // 4
    {0x3F, 0x03, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E}, // 5
    {0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x33, 0x1E}, // 6
    {0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C}, // 7
    {0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x33, 0x1E}, // 8
    {0x1E, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E}, // 9
    {0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // :
    {0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x06, 0x00}, // ;
    {0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00}, // <
    {0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00}, // =
    {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00}, // >
    {0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00}, // ?
    {0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00}, // @
    {0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00}, // A
    {0x1F, 0x36, 0x36, 0x1E, 0x36, 0x36, 0x1F, 0x00}, // B
    {0x1E, 0x33, 0x03, 0x03, 0x03, 0x33, 0x1E, 0x00}, // C
    {0x1F, 0x36, 0x36, 0x36, 0x36, 0x36, 0x1F, 0x00}, // D
    {0x3F, 0x06, 0x06, 0x1E, 0x06, 0x06, 0x3F, 0x00}, // E
    {0x3F, 0x06, 0x06, 0x1E, 0x06, 0x06, 0x06, 0x00}, // F
    {0x1E, 0x33, 0x03, 0x03, 0x73, 0x33, 0x7E, 0x00}, // G
    {0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00}, // H
    {0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // I
    {0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00}, // J
    {0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00}, // K
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x3F, 0x00}, // L
    {0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00}, // M
    {0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00}, // N
    {0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00}, // O
    {0x1F, 0x33, 0x33, 0x1F, 0x03, 0x03, 0x03, 0x00}, // P
    {0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00}, // Q
    {0x1F, 0x33, 0x33, 0x1F, 0x1B, 0x33, 0x33, 0x00}, // R
    {0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00}, // S
    {0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // T
    {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x00}, // U
    {0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}, // V
    {0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00}, // W
    {0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00}, // X
    {0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00}, // Y
    {0x3F, 0x31, 0x18, 0x0C, 0x06, 0x23, 0x3F, 0x00}, // Z
    {0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x1E, 0x00}, // [
    {0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00}, // backslash
    {0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00}, // ]
    {0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00}, // ^
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}, // _
    {0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    {0x00, 0x00, 0x1E, 0x30, 0x3E, 0x33, 0x6E, 0x00}, // a
    {0x07, 0x06, 0x06, 0x1E, 0x36, 0x36, 0x1E, 0x00}, // b
    {0x00, 0x00, 0x1E, 0x33, 0x03, 0x33, 0x1E, 0x00}, // c
    {0x38, 0x30, 0x30, 0x3E, 0x33, 0x33, 0x6E, 0x00}, // d
    {0x00, 0x00, 0x1E, 0x33, 0x3F, 0x03, 0x1E, 0x00}, // e
    {0x1C, 0x36, 0x06, 0x0F, 0x06, 0x06, 0x0F, 0x00}, // f
    {0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x1F}, // g
    {0x07, 0x06, 0x36, 0x6E, 0x66, 0x66, 0x67, 0x00}, // h
    {0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // i
    {0x30, 0x00, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E}, // j
    {0x07, 0x06, 0x66, 0x36, 0x1E, 0x36, 0x67, 0x00}, // k
    {0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00}, // l
    {0x00, 0x00, 0x33, 0x7F, 0x7F, 0x6B, 0x63, 0x00}, // m
    {0x00, 0x00, 0x1F, 0x33, 0x33, 0x33, 0x33, 0x00}, // n
    {0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00}, // o
    {0x00, 0x00, 0x1F, 0x33, 0x33, 0x1F, 0x03, 0x03}, // p
    {0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x30}, // q
    {0x00, 0x00, 0x1B, 0x36, 0x06, 0x06, 0x0F, 0x00}, // r
    {0x00, 0x00, 0x1E, 0x03, 0x1E, 0x30, 0x1F, 0x00}, // s
    {0x08, 0x0C, 0x3E, 0x0C, 0x0C, 0x2C, 0x18, 0x00}, // t
    {0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x6E, 0x00}, // u
    {0x00, 0x00, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00}, // v
    {0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00}, // w
    {0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00}, // x
    {0x00, 0x00, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x1F}, // y
    {0x00, 0x00, 0x3F, 0x19, 0x0C, 0x26, 0x3F, 0x00}, // z
    {0x38, 0x0C, 0x0C, 0x07, 0x0C, 0x0C, 0x38, 0x00}, // {
    {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00}, // |
    {0x07, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0x07, 0x00}, // }
    {0x6E, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ~
};

/**
 * @brief å‘é€å‘½ä»¤åˆ° OLED
 * @param cmd å‘½ä»¤å­—èŠ‚
 */
static void oled_write_cmd(uint8_t cmd)
{
    if (dev_handle == NULL) {
        printf("OLED device handle is NULL\n");
        return;
    }
    
    uint8_t data[2] = {OLED_CONTROL_BYTE_CMD_SINGLE, cmd};
    esp_err_t ret = i2c_master_transmit(dev_handle, data, 2, pdMS_TO_TICKS(100));
    if (ret != ESP_OK) {
        printf("OLED write cmd error: %s (cmd=0x%02X)\n", esp_err_to_name(ret), cmd);
    }
}

/**
 * @brief å‘é€å‘½ä»¤æµåˆ° OLED
 * @param cmds å‘½ä»¤æ•°ç»„
 * @param len å‘½ä»¤æ•°é‡
 */
static void oled_write_cmd_stream(const uint8_t *cmds, size_t len)
{
    uint8_t *data = (uint8_t *)malloc(len + 1);
    if (data == NULL) {
        return;
    }
    data[0] = OLED_CONTROL_BYTE_CMD_STREAM;
    memcpy(data + 1, cmds, len);
    i2c_master_transmit(dev_handle, data, len + 1, -1);
    free(data);
}

/**
 * @brief åˆå§‹åŒ– I2C æ€»çº¿
 * @return ESP_OK æˆåŠŸï¼Œå…¶ä»–å€¼è¡¨ç¤ºå¤±è´¥
 */
static esp_err_t i2c_init(void)
{
    if (bus_handle != NULL && dev_handle != NULL) {
        printf("I2C bus already initialized\n");
        return ESP_OK;
    }

    // å¦‚æœæ€»çº¿å·²å­˜åœ¨ä½†è®¾å¤‡ä¸å­˜åœ¨ï¼Œå…ˆæ¸…ç†
    if (bus_handle != NULL && dev_handle == NULL) {
        i2c_del_master_bus(bus_handle);
        bus_handle = NULL;
    }

    i2c_master_bus_config_t i2c_bus_config = {
        .i2c_port = I2C_NUM_0,
        .sda_io_num = OLED_I2C_SDA_PIN,
        .scl_io_num = OLED_I2C_SCL_PIN,
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .glitch_ignore_cnt = 7,
        .flags = {
            .enable_internal_pullup = true,
        },
    };

    esp_err_t ret = i2c_new_master_bus(&i2c_bus_config, &bus_handle);
    if (ret != ESP_OK) {
        printf("Failed to initialize I2C bus: %s\n", esp_err_to_name(ret));
        return ret;
    }
    printf("I2C bus initialized: SDA=%d, SCL=%d\n", OLED_I2C_SDA_PIN, OLED_I2C_SCL_PIN);

    i2c_device_config_t dev_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = OLED_I2C_ADDRESS,
        .scl_speed_hz = OLED_I2C_FREQ,
    };

    ret = i2c_master_bus_add_device(bus_handle, &dev_cfg, &dev_handle);
    if (ret != ESP_OK) {
        printf("Failed to add I2C device (addr=0x%02X): %s\n", OLED_I2C_ADDRESS, esp_err_to_name(ret));
        i2c_del_master_bus(bus_handle);
        bus_handle = NULL;
        return ret;
    }
    printf("I2C device added: address=0x%02X, speed=%d Hz\n", OLED_I2C_ADDRESS, OLED_I2C_FREQ);

    // ç­‰å¾…æ€»çº¿ç¨³å®š
    vTaskDelay(pdMS_TO_TICKS(50));

    // æ·»åŠ i2c_master_probeï¼Œç¡®ä¿è®¾å¤‡è¿æ¥
    ret = i2c_master_probe(bus_handle, OLED_I2C_ADDRESS, pdMS_TO_TICKS(100));
    if (ret != ESP_OK) {
        printf("I2C device probe failed (addr=0x%02X): %s\n", OLED_I2C_ADDRESS, esp_err_to_name(ret));
        i2c_master_bus_rm_device(dev_handle);
        i2c_del_master_bus(bus_handle);
        dev_handle = NULL;
        bus_handle = NULL;
        return ret;
    }

    return ESP_OK;
}


/**
 * @brief åˆå§‹åŒ– OLED æ˜¾ç¤ºå±
 */
void oled_init(void)
{
    // åˆå§‹åŒ– I2C
    esp_err_t ret = i2c_init();
    if (ret != ESP_OK) {
        printf("Failed to initialize I2C, OLED init aborted\n");
        return;
    }
    
    if (dev_handle == NULL) {
        printf("I2C device handle is NULL, OLED init aborted\n");
        return;
    }
    
    // ç­‰å¾… OLED å‡†å¤‡å°±ç»ª
    vTaskDelay(pdMS_TO_TICKS(100));

    // SSD1306 åˆå§‹åŒ–åºåˆ—ï¼ˆæ¯ä¸ªå‘½ä»¤åæ·»åŠ å°å»¶æ—¶ï¼‰
    oled_write_cmd(SSD1306_DISPLAYOFF);                    // å…³é—­æ˜¾ç¤º
    vTaskDelay(pdMS_TO_TICKS(20));
    
    oled_write_cmd(SSD1306_SETDISPLAYCLOCKDIV);           // è®¾ç½®æ—¶é’Ÿåˆ†é¢‘
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x80);                                 // å»ºè®®å€¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETMULTIPLEX);                 // è®¾ç½®å¤šè·¯å¤ç”¨
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(OLED_HEIGHT - 1);                      // 64-1 = 63
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETDISPLAYOFFSET);            // è®¾ç½®æ˜¾ç¤ºåç§»
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x00);                                 // æ— åç§»
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETSTARTLINE | 0x0);         // è®¾ç½®èµ·å§‹è¡Œ
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_CHARGEPUMP);                   // ç”µè·æ³µè®¾ç½®
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x14);                                 // å¯ç”¨å†…éƒ¨ VCC
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_MEMORYMODE);                  // å†…å­˜æ¨¡å¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x00);                                 // æ°´å¹³å¯»å€æ¨¡å¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SEGREMAP | 0x1);              // æ®µé‡æ˜ å°„ï¼ˆæ°´å¹³ç¿»è½¬ï¼Œä¿®å¤å­—ç¬¦ä¸²é¡ºåºï¼‰
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_COMSCANDEC);                   // COM æ‰«ææ–¹å‘ï¼ˆå‚ç›´ç¿»è½¬ï¼‰
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETCOMPINS);                    // è®¾ç½® COM å¼•è„šé…ç½®
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x12);                                 // 128x64 é…ç½®
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETCONTRAST);                 // è®¾ç½®å¯¹æ¯”åº¦
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0xCF);                                 // å¯¹æ¯”åº¦å€¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETPRECHARGE);                 // é¢„å……ç”µ
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0xF1);                                 // é¢„å……ç”µå€¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_SETVCOMDETECT);                // VCOM æ£€æµ‹
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(0x40);                                 // VCOM å€¼
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_DISPLAYALLON_RESUME);          // å…¨éƒ¨æ˜¾ç¤ºå¼€å¯ï¼ˆä¸é—ªçƒï¼‰
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_NORMALDISPLAY);                // æ­£å¸¸æ˜¾ç¤ºï¼ˆéåè‰²ï¼‰
    vTaskDelay(pdMS_TO_TICKS(1));
    oled_write_cmd(SSD1306_DISPLAYON);                    // å¼€å¯æ˜¾ç¤º

    // æ¸…ç©ºæ˜¾ç¤ºç¼“å†²åŒº
    memset(oled_buffer, 0, sizeof(oled_buffer));
    
    vTaskDelay(pdMS_TO_TICKS(100));
    printf("OLED initialized successfully\n");
}

/**
 * @brief æ¸…ç©ºæ˜¾ç¤ºç¼“å†²åŒº
 */
void oled_clear(void)
{
    memset(oled_buffer, 0, sizeof(oled_buffer));
}

/**
 * @brief åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶ä¸€ä¸ªå­—ç¬¦
 * @param x åˆ—ä½ç½® (0-127)
 * @param y è¡Œä½ç½® (0-7, æ¯è¡Œ8åƒç´ é«˜)
 * @param c å­—ç¬¦
 */
static void oled_draw_char(int x, int y, char c)
{
    if (x < 0 || x >= OLED_WIDTH - 7 || y < 0 || y >= OLED_PAGES) {
        return;
    }

    // è·å–å­—ç¬¦çš„å­—ä½“æ•°æ®ï¼ˆASCII 32-127ï¼‰
    int char_index = c - 32;
    if (char_index < 0 || char_index >= 96) {
        char_index = 0; // ç©ºæ ¼
    }

    // å°†å­—ç¬¦ç»˜åˆ¶åˆ°ç¼“å†²åŒº
    // font_8x8[char_index][row] æ˜¯ç¬¬rowè¡Œçš„8ä½æ•°æ®ï¼ˆæ°´å¹³æ–¹å‘ï¼‰
    // åœ¨SSD1306ä¸­ï¼Œæ¯ä¸ªå­—èŠ‚çš„8ä½ä»£è¡¨å‚ç›´æ–¹å‘çš„8ä¸ªåƒç´ ï¼ˆä¸€åˆ—ï¼‰
    // éœ€è¦å°†å­—ä½“æ•°æ®çš„æ¯ä¸€åˆ—æå–å‡ºæ¥ï¼Œå†™å…¥åˆ°å¯¹åº”çš„åˆ—ä½ç½®
    for (int col = 0; col < 8; col++) {
        if (x + col < OLED_WIDTH) {
            uint8_t column_data = 0;
            // ä»å­—ä½“æ•°æ®çš„æ¯ä¸€è¡Œä¸­æå–ç¬¬colåˆ—çš„ä½
            for (int row = 0; row < 8; row++) {
                // font_8x8[char_index][row] çš„ç¬¬colä½ï¼ˆä»å³è¾¹æ•°ï¼ŒLSBæ˜¯ç¬¬0ä½ï¼Œä¿®å¤æ°´å¹³é•œåƒï¼‰
                if (font_8x8[char_index][row] & (1 << col)) {
                    // è®¾ç½®column_dataçš„ç¬¬rowä½
                    column_data |= (1 << row);
                }
            }
            oled_buffer[y * OLED_WIDTH + x + col] = column_data;
        }
    }
}

/**
 * @brief åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å­—ç¬¦ä¸²
 * @param x åˆ—ä½ç½® (0-127)
 * @param y è¡Œä½ç½® (0-7)
 * @param str å­—ç¬¦ä¸²
 */
void oled_draw_string(int x, int y, const char *str)
{
    int pos_x = x;
    while (*str && pos_x < OLED_WIDTH - 7) {
        oled_draw_char(pos_x, y, *str);
        pos_x += 8; // å­—ç¬¦å®½åº¦ä¸º 8 åƒç´ 
        str++;
    }
}

/**
 * @brief æ›´æ–° OLED æ˜¾ç¤ºï¼ˆå°†ç¼“å†²åŒºå†…å®¹å‘é€åˆ° OLEDï¼‰
 */
void oled_update(void)
{
    if (dev_handle == NULL) {
        printf("OLED device handle is NULL, cannot update display\n");
        return;
    }

    // è®¾ç½®åˆ—åœ°å€èŒƒå›´
    oled_write_cmd(SSD1306_COLUMNADDR);
    oled_write_cmd(0);                    // èµ·å§‹åˆ—
    oled_write_cmd(OLED_WIDTH - 1);      // ç»“æŸåˆ—

    // è®¾ç½®é¡µåœ°å€èŒƒå›´
    oled_write_cmd(SSD1306_PAGEADDR);
    oled_write_cmd(0);                    // èµ·å§‹é¡µ
    oled_write_cmd(OLED_PAGES - 1);       // ç»“æŸé¡µ
    
    // åˆ†å—å‘é€æ˜¾ç¤ºæ•°æ®ï¼Œæ¯æ¬¡å‘é€ 16 å­—èŠ‚ï¼Œé¿å… I2C è¶…æ—¶
    #define CHUNK_SIZE 16
    uint8_t data_buf[CHUNK_SIZE + 1];  // ä½¿ç”¨æ ˆç¼“å†²åŒºï¼Œé¿å…åŠ¨æ€åˆ†é…
    
    for (int page = 0; page < OLED_PAGES; page++) {
        uint8_t *page_data = &oled_buffer[page * OLED_WIDTH];
        
        // å°†æ¯é¡µæ•°æ®åˆ†æˆå¤šä¸ªå—ä¼ è¾“
        for (int offset = 0; offset < OLED_WIDTH; offset += CHUNK_SIZE) {
            int chunk_len = (OLED_WIDTH - offset < CHUNK_SIZE) ? (OLED_WIDTH - offset) : CHUNK_SIZE;
            
            data_buf[0] = OLED_CONTROL_BYTE_DATA_STREAM;
            memcpy(data_buf + 1, page_data + offset, chunk_len);
            
            esp_err_t ret = i2c_master_transmit(dev_handle, data_buf, chunk_len + 1, pdMS_TO_TICKS(200));
            
            if (ret != ESP_OK) {
                printf("OLED update page %d chunk %d error: %s\n", page, offset / CHUNK_SIZE, esp_err_to_name(ret));
                return;
            }
            
            // å°å»¶æ—¶é¿å…è¿‡å¿«ä¼ è¾“
            vTaskDelay(pdMS_TO_TICKS(1));
        }
    }
}

/**
 * @brief æ¸…å±å‡½æ•°ï¼Œæ¸…ç©ºç¼“å†²åŒºå¹¶ç«‹å³æ›´æ–°æ˜¾ç¤º
 */
void oled_clear_display(void)
{
    // æ¸…ç©ºæ˜¾ç¤ºç¼“å†²åŒº
    oled_clear();
    // ç«‹å³æ›´æ–°æ˜¾ç¤ºï¼Œå°†æ¸…ç©ºåçš„ç¼“å†²åŒºå‘é€åˆ° OLED
    oled_update();
}

```

IÂ²C åœ¨è¿™é‡Œåªæ˜¯**é€šä¿¡æ‰‹æ®µ**ï¼Œè€Œä¸æ˜¯ä¸šåŠ¡é€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚

è€Œåœ¨ä¸šåŠ¡å±‚ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨æˆ‘ä»¬çš„é©±åŠ¨å‡½æ•°ï¼š
**main.c**
```c
#include <stdio.h>              // å¼•å…¥æ ‡å‡†è¾“å…¥è¾“å‡ºåº“ï¼Œç”¨äºä½¿ç”¨ printf å‡½æ•°
#include "freertos/FreeRTOS.h"  // å¼•å…¥ FreeRTOS çš„æ ¸å¿ƒå¤´æ–‡ä»¶ï¼Œæä¾› FreeRTOS çš„åŸºæœ¬åŠŸèƒ½
#include "freertos/task.h"      // å¼•å…¥ FreeRTOS çš„ä»»åŠ¡ç®¡ç†å¤´æ–‡ä»¶ï¼Œæä¾›ä»»åŠ¡ç›¸å…³çš„å‡½æ•°ï¼ˆå¦‚ vTaskDelayï¼‰
#include "sdkconfig.h"
#include "esp_err.h"
#include "oled.h"

void app_main(void)             // ESP-IDF ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œç±»ä¼¼äº main å‡½æ•°
{
    oled_init();
    oled_clear();
    oled_draw_string(0, 0, "Hello ESP32-S3");
    oled_update();
    
    while (1)
    {
        vTaskDelay(50 / portTICK_PERIOD_MS);
    }
}
```

ä»£ç è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/fb5ea98798a44dd09ff33a720b1b3138.png)


---


### å®˜æ–¹æ–‡æ¡£å‚è€ƒ

ESP-IDF IÂ²Cï¼ˆESP32-S3ï¼‰
[https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4/esp32s3/api-reference/peripherals/i2c.html](https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4/esp32s3/api-reference/peripherals/i2c.html)

---
