---
title: "为什么我一开始把 ESP32-S3 的 SPI 用得一塌糊涂"
category: "ESP32"
tags: [ESP32, 通信协议,ESP-IDF]
featured: false
---

## 一、为什么我一开始把 ESP32-S3 的 SPI 用得一塌糊涂

刚接触 ESP32-S3 的时候，我对 SPI 的理解非常“朴素”：

> SPI 就是：
> 选个 SPI 口 → 接 MOSI / MISO / CLK / CS → 发数据

直到后来我同时接了 **SPI Flash、PSRAM、LCD 屏幕、EEPROM**，
开始遇到下面这些问题：

* 为什么 **SPI0 / SPI1 我一用就出问题**
* DMA 开不开，对稳定性影响这么大？
* 同样是 SPI，**屏幕和 EEPROM 的配置完全不一样**

后来回头看 ESP-IDF 的设计，才发现：
**不是我代码写得烂，是我一开始就没理解 SPI 的分层设计。**

---

## 二、ESP32-S3 的 4 个 SPI 控制器，根本不是给你“随便用的”

ESP32-S3 一共有 **4 个 SPI 控制器**，但真正给应用层用的，其实只有两个。

### SPI 控制器分工一览

* **SPI0**

  * 给 Cache + GDMA 用
  * 访问 Flash / PSRAM
* **SPI1**

  * 给 CPU 直接访问 Flash / PSRAM
* **SPI2**

  * ✅ 通用 SPI（应用层主力）
* **SPI3**

  * ✅ 通用 SPI（应用层主力）

📌 **结论一句话：**

> **SPI0 / SPI1 是“系统命脉”**
> **SPI2 / SPI3 才是“你该用的 SPI”**

![Functional Block Diagram](https://i-blog.csdnimg.cn/direct/208e6eeb783e429cb0b0cd864fb00b8a.png)
https://documentation.espressif.com/esp32-s3_datasheet_en.pdf?utm_source=chatgpt.com

---

## 三、GPIO 为什么“看起来能用”，但官方却不推荐？

这是很多人（包括我）一开始会踩的坑。

### SPI0 / SPI1 的 GPIO 实际情况

* 模组 / 官方参考设计中：

  * **GPIO26 ~ GPIO32**：Flash / PSRAM
  * **GPIO33 ~ GPIO37**：

    * 八线 Flash
    * 八线 PSRAM
    * DQS 信号

👉 **这些 GPIO：不推荐你再复用**

哪怕你代码能跑，也可能在下面情况直接翻车：

* Cache miss
* PSRAM 访问异常
* 高负载下随机死机

### SPI2 / SPI3 的优势

* 通过 **GPIO Matrix**
* **几乎任意 GPIO 都能接**
* 才是真正意义上的“通用 SPI”

📌 **工程建议**：

> **应用层 SPI：只选 SPI2 / SPI3**

---

## 四、ESP-IDF 的 SPI 驱动，其实是“三层结构”

ESP-IDF 的 SPI 主机驱动不是“一个函数搞定”，
而是通过 **三个结构体**共同决定一次 SPI 通信的行为。

### 1️⃣ SPI 总线层：`spi_bus_config_t`

它决定的是：

* 用哪几个 GPIO
* DMA 能不能用
* 单次最大传输多大

```c
spi_bus_config_t buscfg = {
    .miso_io_num = PIN_NUM_MISO,
    .mosi_io_num = PIN_NUM_MOSI,
    .sclk_io_num = PIN_NUM_CLK,
    .quadwp_io_num = -1,
    .quadhd_io_num = -1,
    .max_transfer_sz = 320,
};
```

👉 **这是“物理总线层”**

---

### 2️⃣ 设备层：`spi_device_interface_config_t`

这一层，才是 **最容易踩坑的地方**。

它决定：

* SPI 模式（CPOL / CPHA）
* 时钟频率
* CS 怎么控制
* 是否半双工
* 是否 LSB 优先
* 是否用回调函数控 CS / DC

#### LCD 屏幕 vs EEPROM 的差异

**LCD 屏幕：**

* 高速
* 可排队多个事务
* 有 D/C 线
* 通常全双工

**EEPROM：**

* 低速
* 半双工
* CS 需要精确控制
* 读写延迟明显

👉 **所以它们的 devcfg 完全不可能一样**

官方连接：https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4.3/esp32s3/api-reference/peripherals/spi_master.html

---

### 3️⃣ 事务层：`spi_transaction_t`

这是**真正的一次 SPI 传输**。

你可以精确控制：

* 命令位数
* 地址位数
* 数据长度
* 用 DMA 还是内部 buffer
* CS 是否保持

```c
spi_transaction_t t = {
    .length = 8 * 4,
    .rxlength = 8 * 4,
    .tx_buffer = tx_buf,
    .rx_buffer = rx_buf,
};
```

📌 一个很容易忽略的点：

> **length / rxlength 的单位是“位”，不是字节**

---

## 五、SPI 屏幕：为什么我最后一定会单独写一套驱动？

以 ST7789 这类 SPI 屏为例，看起来只是：

> SPI + GPIO + 刷图

但实际上你会遇到：

* 异形屏（物理分辨率 ≠ 驱动分辨率）
* 显存偏移
* DC / CS / RST 多控制线
* DMA 对齐问题
* 刷屏撕裂

### 异形屏偏移问题（非常典型）

240 × 320 的驱动芯片
实际屏幕：172 × 320

👉 左右各 **34 列是“空气”**

所以你必须在：

* 设置地址窗口
* 显存映射
* draw 区域
时，**人为做偏移**
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/082df444d9e84e298a7aaf926ed0f82b.png)


---

## 六、我现在对 ESP32-S3 SPI 的“最终认知”

到现在为止，我基本形成了一套固定思路：

* **SPI2 / SPI3：应用层唯一选择**
* **总线配置只做一次**
* **设备配置必须“按器件定制”**
* **事务层是性能和稳定性的核心**
* **LCD / EEPROM / 传感器，绝不共用一套配置思路**